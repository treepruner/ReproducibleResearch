---
title: "Health and Economic Impacts of US Storms"
author: "treepruner"
date: "November 15, 2015"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

rm(list = ls())

```{r load_packages, echo = TRUE, message = FALSE}
library(lubridate)
library(dplyr)
library(sqldf)
library(xtable)
library(ggplot2)
library(mosaic)
```


### Synopsis

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

Additional inforation can be found at these websites:

https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf

https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf



### Executive summary
This analysis addressed these questions: 

 * Across the United States, which types of events are most harmful with respect to population health?

In total, the most fatalities occur due to tornados. Heat is the second most prevelant cause of fatalities

Injuries are incurred as a result of tornados more than any other event group.


 * Across the United States, which types of events have the greatest economic consequences?

For crop damages, extremes of water- drought and flooding are each more than twice as expensive as the next event group.

For property damages, hurricanes, tornados, and flooding are the most expensive types of event group.


### Data Processing

#### Load Data


```{r getData, echo = TRUE}
fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

download.file(fileURL, "./proj2/repdata%2Fdata%2FStormData.csv.bz2")

sd <- read.csv("./proj2/repdata%2Fdata%2FStormData.csv.bz2")

# save original
saveRDS(stormData, "./proj2/stormData.rds")


```



#### Explore Data
```{r getData, echo = TRUE}
str(sd)
```

#### Clean/Preprocess Data
lubridate was used to convert the dates that are factors into date fields.

```{r date_cleanup, echo = TRUE}

sd$BGN_DATE <- mdy_hms(sd$BGN_DATE)
sd$END_DATE <- mdy_hms(sd$END_DATE)

```

There are 985 unique EVTYPE codes, which is too large to use. The EVTYPE codes were grouped together into 38 groups. This mapping was created by extracting the 985 EVTYPE codes and manually assigning them to a group. The storm data file was joined to the mapping file on EVTYPE with sqldf and the new EnvTypeGroup code was added.

To make this reproducible, the mapping file has been read in to this document:


```{r EnvTypeGroupTable, echo = TRUE results="asis"}
envTypeMapping <- read.csv("./proj2/envTypeList.csv",  sep = ",")[, 2:3]
print(xtable(envTypeMapping) ,  type="html")                                                               

```

```{r addEnvTypeGroup, echo = TRUE}
sd <- sqldf( 
        "select s.*, e.envTypeGroup   
         from sd s join envTypeMapping e on s.EVTYPE = e.ENVTYPE")

```


Determine if the REFNUM identifies a unique row. Remove duplicate REFNUMs. This removed records were exactly the same in all fields so that only 1 record remained in the file. There is another pair of records, REFNUM 605943 and 567221 that although they have different REFNUMs, appear to be for the same event. The REMARKS refer to millions in damage, so REFNUM 605943 which referred to billions in PROPDMGEXP, was removed.

```{r dup_refnum_check, echo = TRUE}
dup_refnum <- sqldf( 
        "select s.REFNUM, count(*)   
         from sd s 
         group by s.REFNUM
         having count(*) > 1")

dup_refnum

sd <- sqldf( 
        "select distinct s.*   
         from sd s" 
         )

# thes code also works and was actually faster
# sd1 <- sd[!duplicated(sd),] 



```

The PROPDMG field is the numerical component of the property damage and the PROPDMGEXP is the units, however, the units field is dirty. The numerical field was multiplied as follows: 
 * Bb = billions
 * Mm = millions 
 * Kk = thousands
 * Hh = hundreds
 * ?  = 0
 * anything else = millions
 
The CROPDMG field is the numerical component of the crop damage and the CROPDMGEXP is the units, however, the units field is dirty. The numerical field was multiplied as follows: 
 * Bb = billions
 * Mm = millions 
 * Kk = thousands
 * Hh = hundreds
 * ?  = 0
 * anything else = millions

Another field was added to indicate the reliability of the numbers. The assumption about "anything else"  and "?" was coded as low reliability.

The events in this file range from 1950 to 2011. To truely be comparable and understandable to the modern audience, the damage dollar amounts should be adjusted using an appropriate price index into current dollars in order to properly rank the financial impact of each event. This was deemed out of scope for our assignment.



```{r fix_amts, echo = TRUE}
sd1 <- sqldf( 
        "select  REFNUM
        , BGN_DATE
        , END_DATE
        , EVTYPE
        , EnvTypeGroup
        , FATALITIES
        , INJURIES
        , PROPDMG
        , PROPDMGEXP
        , case 
                when upper(PROPDMGEXP) = 'B' then PROPDMG * 1000000000
                when upper(PROPDMGEXP) = 'M' then PROPDMG * 1000000
                when upper(PROPDMGEXP) = 'K' then PROPDMG * 1000
                when upper(PROPDMGEXP) = 'H' then PROPDMG * 100
                when upper(PROPDMGEXP) = '?' then PROPDMG * 0
           else PROPDMG * 1000000
           end as PropertyDamageAmt
        , CROPDMG
        , CROPDMGEXP
        , case 
                when upper(CROPDMGEXP) = 'B' then CROPDMG * 1000000000
                when upper(CROPDMGEXP) = 'M' then CROPDMG * 1000000
                when upper(CROPDMGEXP) = 'K' then CROPDMG * 1000
                when upper(CROPDMGEXP) = 'H' then CROPDMG * 100
                when upper(CROPDMGEXP) = '?' then CROPDMG * 0
           else CROPDMG * 1000000
           end as CropDamageAmt
        , case 
                when upper(PROPDMGEXP) not in ('B', 'M', 'K', 'H') then 'Low'
                when upper(CROPDMGEXP) not in ('B', 'M', 'K', 'H') then 'Low'
          else 'High'
          end as reliability
        , REMARKS   
         from sd
         where REFNUM <> 605943 "          )

saveRDS(sd, "./proj2/sd.rds")

```         
         
### Create Summaries by Event Group

```{r pop_stats, echo = TRUE}
pop_fatalities <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , Fatalities.Count = sum(FATALITIES) 
                  , Fatalities.Mean = mean(FATALITIES)
                  , Fatalities.Median = median(FATALITIES)
                  , Fatalities.Min = min(FATALITIES)
                  , Fatalities.Max = max(FATALITIES)        ) %>% 
        arrange(desc(Fatalities.Count))


pop_injuries <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , Injuries.Count = sum(INJURIES) 
                  , Injuries.Mean = mean(INJURIES)
                  , Injuries.Median = median(INJURIES)
                  , Injuries.Min = min(INJURIES)
                  , Injuries.Max = max(INJURIES)    ) %>% 
        arrange(desc(Injuries.Count))
        

```



```{r damage_stats, echo = TRUE}
cost_PropertyDamage <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , PropertyDamageAmt.Sum = sum(PropertyDamageAmt) 
                  , PropertyDamageAmt.Mean = mean(PropertyDamageAmt)
                  , PropertyDamageAmt.Median = median(PropertyDamageAmt)
                  , PropertyDamageAmt.Min_ = min(PropertyDamageAmt)
                  , PropertyDamageAmt.Max = max(PropertyDamageAmt)   ) %>% 
        arrange(desc(PropertyDamageAmt.Sum))

cost_PropertyDamage_High <- 
        sd1 %>% 
        filter(reliability == "High")  %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , PropertyDamageAmt.Sum = sum(PropertyDamageAmt) 
                  , PropertyDamageAmt.Mean = mean(PropertyDamageAmt)
                  , PropertyDamageAmt.Median = median(PropertyDamageAmt)
                  , PropertyDamageAmt.Min_ = min(PropertyDamageAmt)
                  , PropertyDamageAmt.Max = max(PropertyDamageAmt)   ) %>% 
        arrange(desc(PropertyDamageAmt.Sum))


cost_CropDamage <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n_date = n()
                  , CropDamageAmt.Sum = sum(CropDamageAmt) 
                  , CropDamageAmt.Mean = mean(CropDamageAmt)
                  , CropDamageAmt.Median = median(CropDamageAmt)
                  , CropDamageAmt.Min = min(CropDamageAmt)
                  , CropDamageAmt.Max = max(CropDamageAmt)   ) %>% 
        arrange(desc(CropDamageAmt.Sum))

cost_CropDamage_High <- 
        sd1 %>% 
        filter(reliability == "High")  %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n_date = n()
                  , CropDamageAmt.Sum = sum(CropDamageAmt) 
                  , CropDamageAmt.Mean = mean(CropDamageAmt)
                  , CropDamageAmt.Median = median(CropDamageAmt)
                  , CropDamageAmt.Min = min(CropDamageAmt)
                  , CropDamageAmt.Max = max(CropDamageAmt)   ) %>% 
        arrange(desc(CropDamageAmt.Sum))


```

### Results


The fatalities from 1950 - 2011 are as follows:

```{r FatalitiesTable, echo = TRUE,  results="asis"}
fatalities <- xtable(pop_fatalities )
print(fatalities, type="html")
```

The injuries from  1950 - 2011 are as follows:

```{r InjuriesTable, echo = TRUE,  results="asis"}

injuries <- xtable(pop_injuries )
print(injuries, type="html")

```



Total property damages are as follows:

```{r PropertyDamageTable, echo = TRUE,  results="asis"}
PropertyDamage <- xtable(cost_PropertyDamage )
print(PropertyDamage, type="html")
```

Retaining only the records with high reliabiltiy cost extimates doesn't signnificantly change the relative rankings on property damage: 

```{r ReliablePropertyDamageTable, echo = TRUE,  results="asis"}
PropertyDamageHigh <- xtable(cost_PropertyDamage_High )
print(PropertyDamageHigh, type="html")
```

Total crop damages are as follows:

```{r CropDamageTable, echo = TRUE,  results="asis"}
CropDamage <- xtable(cost_CropDamage )
print(CropDamage, type="html")
```


Retaining only the records with high reliabiltiy cost extimates DOES signnificantly change the relative rankings for crop damages. Drought is now # 12 in the rankings: 

```{r ReliableCropDamageTable, echo = TRUE,  results="asis"}
CropDamageHigh <- xtable(cost_CropDamage_High )
print(CropDamageHigh, type="html")
```



### Conclusion




#### 

```{r, echo = TRUE }

```





`

### Results

 1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

 2. Across the United States, which types of events have the greatest economic consequences?