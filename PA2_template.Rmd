---
title: "Health and Economic Impacts of U.S. Storms"
author: "treepruner"
date: "November 15, 2015"
output: 
        html_document:
                keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

rm(list = ls())

```{r load_packages, echo = TRUE, message = FALSE}
library(lubridate)
library(dplyr)
library(sqldf)
library(xtable)
library(ggplot2)
library(mosaic)
```


### Synopsis

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage. The file contains data from 1950 - 2011.

The United States population health is impacted by weather events in terms of both fatalities and injuries.

The most fatalities occur due to tornados. Heat is the second most prevelant cause of fatalities.

More injuries are incurred as a result of tornados more than any other event group.

The greatest economic consequences are more difficult to determine due to the inconsistency of the cost unit coding. If ambiguous units are assumed to be in millions, extremes of water- drought and flooding are each more than twice as expensive as the next event group in the crop damage rankings.

For property damages, hurricanes, tornados, and flooding are the most expensive event groups.


### Data Processing

#### Load Data


```{r getData, echo = TRUE}
fileURL <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"

download.file(fileURL, "./proj2/repdata%2Fdata%2FStormData.csv.bz2")

sd <- read.csv("./proj2/repdata%2Fdata%2FStormData.csv.bz2")

# save original
saveRDS(stormData, "./proj2/stormData.rds")


```


#### Explore Data

```{r exploreData, echo = TRUE}
str(sd)
head(sd, 1)
```

#### Clean/Preprocess Data

##### Dates

lubridate was used to convert the dates that are factors into date fields.

```{r date_cleanup, echo = TRUE}
sd$BGN_DATE <- mdy_hms(sd$BGN_DATE)
sd$END_DATE <- mdy_hms(sd$END_DATE)

```


##### Group EVTYPE Codes

There are 985 unique EVTYPE codes, many of which are very similar. Rankings using this EVTYPE as it stands would be too disaggregated to be useful.

The EVTYPE codes were grouped together into 38 groups. This mapping was created by extracting the 985 unique EVTYPE codes and manually assigning them to a group. The storm data file was joined to the mapping file on EVTYPE with sqldf and the new EnvTypeGroup code was added.

To make this reproducible by others, the entire mapping file has been read in to this documen in the appendix:

```{r EnvTypeGroupMapping, echo = TRUE}
envTypeMapping <- read.csv("./proj2/envTypeList.csv",  sep = ",")[, 2:3]

sd <- sqldf( 
        "select s.*, e.envTypeGroup   
         from sd s join envTypeMapping e on s.EVTYPE = e.ENVTYPE")

```


##### Duplicates 

Check for duplicates. Determine if the REFNUM identifies a unique row. Remove duplicate REFNUMs. This removed records that were exactly the same in all fields so that only 1 record out of the multiples remained in the file. 

There is another pair of records, REFNUM 605943 and 567221 that although they have different REFNUMs, appear to be for the same event. The REMARKS refer to millions in damage, so REFNUM 605943 which referred to billions in PROPDMGEXP, was removed.

```{r duplicates, echo = TRUE}
dup_refnum <- sqldf( 
        "select s.REFNUM, count(*)   
         from sd s 
         group by s.REFNUM
         having count(*) > 1")

dup_refnum

sd <- sqldf( 
        "select distinct s.*   
         from sd s" 
         )

# thes code also works and was actually faster
# sd1 <- sd[!duplicated(sd),] 
```

##### Economic Damage Fields

The PROPDMG field is the numerical component of the property damage and the PROPDMGEXP is the units, however, the units field is dirty. The numerical field was multiplied as follows: 
 * Bb = billions
 * Mm = millions 
 * Kk = thousands
 * Hh = hundreds
 * ?  = 0
 * anything else = millions
 
The CROPDMG field is the numerical component of the crop damage and the CROPDMGEXP is the units, however, the units field is also dirty. The numerical field was multiplied as follows: 
 * Bb = billions
 * Mm = millions 
 * Kk = thousands
 * Hh = hundreds
 * ?  = 0
 * anything else = millions

Another field was added to indicate the reliability of the numbers. The assumption about "anything else"  and "?" was coded as low reliability. 

The REMARKS have cost numbers that do not always match the cost fields for that record. A future analysis should compare these fields and either adjust the  reliability and/or update the damage numbers.

The events in this file range from 1950 to 2011. To truely be comparable and understandable to the modern audience, the damage dollar amounts should be adjusted using an appropriate price index into current dollars in order to properly rank the financial impact of each event. This was deemed out of scope for our assignment.


```{r fix_amts, echo = TRUE}
sd1 <- sqldf( 
        "select  REFNUM
        , BGN_DATE
        , END_DATE
        , EVTYPE
        , EnvTypeGroup
        , FATALITIES
        , INJURIES
        , PROPDMG
        , PROPDMGEXP
        , case 
                when upper(PROPDMGEXP) = 'B' then PROPDMG * 1000000000
                when upper(PROPDMGEXP) = 'M' then PROPDMG * 1000000
                when upper(PROPDMGEXP) = 'K' then PROPDMG * 1000
                when upper(PROPDMGEXP) = 'H' then PROPDMG * 100
                when upper(PROPDMGEXP) = '?' then PROPDMG * 0
           else PROPDMG * 1000000
           end as PropertyDamageAmt
        , CROPDMG
        , CROPDMGEXP
        , case 
                when upper(CROPDMGEXP) = 'B' then CROPDMG * 1000000000
                when upper(CROPDMGEXP) = 'M' then CROPDMG * 1000000
                when upper(CROPDMGEXP) = 'K' then CROPDMG * 1000
                when upper(CROPDMGEXP) = 'H' then CROPDMG * 100
                when upper(CROPDMGEXP) = '?' then CROPDMG * 0
           else CROPDMG * 1000000
           end as CropDamageAmt
        , case 
                when upper(PROPDMGEXP) not in ('B', 'M', 'K', 'H') then 'Low'
                when upper(CROPDMGEXP) not in ('B', 'M', 'K', 'H') then 'Low'
          else 'High'
          end as reliability
        , REMARKS   
         from sd
         where REFNUM <> 605943 "          )

saveRDS(sd, "./proj2/sd.rds")

```         
         
### Results by Event Group

#### Population Health Stastics by Event Group


```{r fatalities_stats, echo = TRUE}
pop_fatalities <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , Fatalities.Count = sum(FATALITIES) 
                  , Fatalities.Mean = mean(FATALITIES)
                  , Fatalities.Median = median(FATALITIES)
                  , Fatalities.Min = min(FATALITIES)
                  , Fatalities.Max = max(FATALITIES)        ) %>% 
        arrange(desc(Fatalities.Count))

```


The fatalities from 1950 - 2011 are ranked as follows:

```{r FatalitiesTable, echo = TRUE,  results="asis"}
fatalities <- xtable(pop_fatalities[pop_fatalities$Fatalities.Count != 0,] )
print(fatalities, type="html")
```

Fatalities by Year

```{r fatalities_yr_stats, echo = TRUE}
pop_fatalities_yr <- 
        sd1 %>% 
        mutate(Year = year(BGN_DATE)) %>% 
        group_by(Year, EnvTypeGroup) %>% 
        summarise(n = n()
                  , Fatalities.Count = sum(FATALITIES) ) %>%
        arrange(Year) %>%
        filter(EnvTypeGroup %in% c("Tornado/Waterspout", "Heat", "Flooding" ))
  
```


Top fatality event groups by year show that the data may be incomplete or have quality issues since there are no flooding or heat related deaths prior to 1990.

```{r Figure 1, echo = TRUE}
ggplot( data = pop_fatalities_yr
        , aes(x = Year
        , y = Fatalities.Count , colour = EnvTypeGroup)) +
        geom_point() + 
        facet_grid(EnvTypeGroup ~ .) +
        geom_line()  + 
        theme(legend.position = "bottom")
```




```{r injuries_stats, echo = TRUE}
pop_injuries <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , Injuries.Count = sum(INJURIES) 
                  , Injuries.Mean = mean(INJURIES)
                  , Injuries.Median = median(INJURIES)
                  , Injuries.Min = min(INJURIES)
                  , Injuries.Max = max(INJURIES)    ) %>% 
        arrange(desc(Injuries.Count))

```


The injuries from  1950 - 2011 are ranked as follows:

```{r InjuriesTable, echo = TRUE,  results="asis"}

injuries <- xtable(pop_injuries[pop_injuries$Injuries.Count != 0,] )
print(injuries, type="html")

```


```{r injuries_yr_stats, echo = TRUE}
pop_injuries_yr <- 
        sd1 %>% 
        mutate(Year = year(BGN_DATE)) %>% 
        group_by(Year, EnvTypeGroup) %>% 
        summarise(n = n()
                  , Injuries.Count = sum(INJURIES) ) %>%
        arrange(Year) %>%
        filter(EnvTypeGroup %in% c("Tornado/Waterspout", "Heat", "Flooding", "Wind", "Wintery Mix", "Lightning", "Lighting" ))
  
```


Top fatality event groups by year show that the data may be incomplete or have quality issues since several of the high count event groups have no injuries prior to 1990

```{r Figure 2, echo = TRUE}
ggplot( data = pop_injuries_yr
        , aes(x = Year
        , y = Injuries.Count, colour = EnvTypeGroup)) +
        geom_point() + 
        facet_grid(EnvTypeGroup ~ .) +
        geom_line() + 
        theme(legend.position = "bottom")

```




#### Economic Impacts

```{r damage_stats, echo = TRUE}
cost_PropertyDamage <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , PropertyDamageAmt.Sum = sum(PropertyDamageAmt) 
                  , PropertyDamageAmt.Mean = mean(PropertyDamageAmt)
                  , PropertyDamageAmt.Median = median(PropertyDamageAmt)
                  , PropertyDamageAmt.Min_ = min(PropertyDamageAmt)
                  , PropertyDamageAmt.Max = max(PropertyDamageAmt)   ) %>% 
        arrange(desc(PropertyDamageAmt.Sum))

cost_PropertyDamage_High <- 
        sd1 %>% 
        filter(reliability == "High")  %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n = n()
                  , PropertyDamageAmt.Sum = sum(PropertyDamageAmt) 
                  , PropertyDamageAmt.Mean = mean(PropertyDamageAmt)
                  , PropertyDamageAmt.Median = median(PropertyDamageAmt)
                  , PropertyDamageAmt.Min_ = min(PropertyDamageAmt)
                  , PropertyDamageAmt.Max = max(PropertyDamageAmt)   ) %>% 
        arrange(desc(PropertyDamageAmt.Sum))


cost_CropDamage <- 
        sd1 %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n_date = n()
                  , CropDamageAmt.Sum = sum(CropDamageAmt) 
                  , CropDamageAmt.Mean = mean(CropDamageAmt)
                  , CropDamageAmt.Median = median(CropDamageAmt)
                  , CropDamageAmt.Min = min(CropDamageAmt)
                  , CropDamageAmt.Max = max(CropDamageAmt)   ) %>% 
        arrange(desc(CropDamageAmt.Sum))

cost_CropDamage_High <- 
        sd1 %>% 
        filter(reliability == "High")  %>% 
        group_by(EnvTypeGroup) %>% 
        summarise(n_date = n()
                  , CropDamageAmt.Sum = sum(CropDamageAmt) 
                  , CropDamageAmt.Mean = mean(CropDamageAmt)
                  , CropDamageAmt.Median = median(CropDamageAmt)
                  , CropDamageAmt.Min = min(CropDamageAmt)
                  , CropDamageAmt.Max = max(CropDamageAmt)   ) %>% 
        arrange(desc(CropDamageAmt.Sum))


```


Total property damages from 1950 - 2011 (assuming millions for ambiguous cost units) are as follows:

```{r PropertyDamageTable, echo = TRUE,  results="asis"}
PropertyDamage <- xtable(cost_PropertyDamage[cost_PropertyDamage$PropertyDamageAmt.Sum != 0,] )
print(PropertyDamage, type="html")
```

Retaining only the records with high reliabiltiy cost estimates doesn't signnificantly change the relative rankings on property damage: 

```{r ReliablePropertyDamageTable, echo = TRUE,  results="asis"}
PropertyDamageHigh <- xtable(cost_PropertyDamage_High[cost_PropertyDamage_High$PropertyDamageAmt.Sum != 0,] )
print(PropertyDamageHigh, type="html")
```

Total crop damages from 1950 - 2011 (assuming millions for ambiguous cost units) are as follows:

```{r CropDamageTable, echo = TRUE,  results="asis"}
CropDamage <- xtable(cost_CropDamage[cost_CropDamage$CropDamageAmt.Sum != 0,] )
print(CropDamage, type="html")
```


Retaining only the records with high reliabiltiy cost extimates DOES signnificantly change the relative rankings for crop damages. Drought is now # 12 in the rankings: 

```{r ReliableCropDamageTable, echo = TRUE,  results="asis"}
CropDamageHigh <- xtable(cost_CropDamage_High[cost_CropDamage$CropDamageAmt.Sum != 0,] )
print(CropDamageHigh, type="html")
```




### Conclusion

The United States population health is impacted by weather events in terms of both fatalities and injuries.

The most fatalities occur due to tornados. Heat is the second most prevelant cause of fatalities.

More injuries are incurred as a result of tornados more than any other event group.

The greatest economic consequences are more difficult to determine due to the inconsistency of the cost unit coding. If ambiguous units are assumed to be in millions, extremes of water- drought and flooding are each more than twice as expensive as the next event group in the crop damage rankings.

For property damages, hurricanes, tornados, and flooding are the most expensive event groups.


 
### Appendix

Additional information can be found at these websites:

https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf

https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf


#### EVTYPE Grouping Table
The mapping table needs to be extracted from the HTML/PDF and created locally to reproduce the results.

```{r EnvTypeGroupTable, echo = TRUE results="asis"}
print(xtable(envTypeMapping) ,  type="html")                                                     

```